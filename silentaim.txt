
-- Universal Silent Aim - Mobile Optimized GUI
-- Giữ nguyên toàn bộ chức năng, chỉ thay đổi GUI

-- init
if not game:IsLoaded() then 
    game.Loaded:Wait()
end

if not syn or not protectgui then
    getgenv().protectgui = function() end
end

local SilentAimSettings = {
    Enabled = false,
    
    ClassName = "Universal Silent Aim - Averiias, Stefanuk12, xaxa",
    ToggleKey = "RightAlt",
    
    TeamCheck = false,
    VisibleCheck = false, 
    TargetPart = "HumanoidRootPart",
    SilentAimMethod = "Raycast",
    
    FOVRadius = 360,
    FOVVisible = false,
    ShowSilentAimTarget = false, 
    
    MouseHitPrediction = false,
    MouseHitPredictionAmount = 0.165,
    HitChance = 100,
    
    -- New settings
    TargetPriority = "Closest", -- "Closest" or "Farthest"
    MaxDistance = 5000, -- Maximum aim distance
    TeamAimTarget = "None", -- Specific team to target or "None"
    
    -- Target Lock settings
    TargetLocked = false,
    LockedTarget = nil, -- Locked player reference
}

-- variables
getgenv().SilentAimSettings = SilentAimSettings
local MainFileName = "UniversalSilentAim"
local SelectedFile, FileToSave = "", ""

local Camera = workspace.CurrentCamera
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local TweenService = game:GetService("TweenService")
local Teams = game:GetService("Teams")

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local GetChildren = game.GetChildren
local GetPlayers = Players.GetPlayers
local WorldToScreen = Camera.WorldToScreenPoint
local WorldToViewportPoint = Camera.WorldToViewportPoint
local GetPartsObscuringTarget = Camera.GetPartsObscuringTarget
local FindFirstChild = game.FindFirstChild
local RenderStepped = RunService.RenderStepped
local GuiInset = GuiService.GetGuiInset
local GetMouseLocation = UserInputService.GetMouseLocation

local resume = coroutine.resume 
local create = coroutine.create

local ValidTargetParts = {"Head", "HumanoidRootPart"}
local PredictionAmount = 0.165

local mouse_box = Drawing.new("Square")
mouse_box.Visible = false 
mouse_box.ZIndex = 999 
mouse_box.Color = Color3.fromRGB(54, 57, 241)
mouse_box.Thickness = 2
mouse_box.Size = Vector2.new(20, 20)
mouse_box.Filled = true
mouse_box.Transparency = 0.5

local fov_circle = Drawing.new("Circle")
fov_circle.Thickness = 2
fov_circle.NumSides = 100
fov_circle.Radius = 130
fov_circle.Filled = false
fov_circle.Visible = false
fov_circle.ZIndex = 999
fov_circle.Transparency = 1
fov_circle.Color = Color3.fromRGB(54, 57, 241)

-- ESP Drawing objects for target player
local esp_box = Drawing.new("Square")
esp_box.Thickness = 2
esp_box.Color = Color3.fromRGB(255, 255, 0)
esp_box.Filled = false
esp_box.Visible = false
esp_box.ZIndex = 998
esp_box.Transparency = 1

local esp_name = Drawing.new("Text")
esp_name.Size = 16
esp_name.Color = Color3.fromRGB(255, 255, 0)
esp_name.Center = true
esp_name.Outline = true
esp_name.Font = Drawing.Fonts.UI
esp_name.Visible = false
esp_name.ZIndex = 998

local esp_distance = Drawing.new("Text")
esp_distance.Size = 14
esp_distance.Color = Color3.fromRGB(255, 255, 100)
esp_distance.Center = true
esp_distance.Outline = true
esp_distance.Font = Drawing.Fonts.UI
esp_distance.Visible = false
esp_distance.ZIndex = 998

local esp_tracer = Drawing.new("Line")
esp_tracer.Thickness = 2
esp_tracer.Color = Color3.fromRGB(255, 255, 0)
esp_tracer.Visible = false
esp_tracer.ZIndex = 998
esp_tracer.Transparency = 1

local ExpectedArguments = {
    FindPartOnRayWithIgnoreList = {
        ArgCountRequired = 3,
        Args = {
            "Instance", "Ray", "table", "boolean", "boolean"
        }
    },
    FindPartOnRayWithWhitelist = {
        ArgCountRequired = 3,
        Args = {
            "Instance", "Ray", "table", "boolean"
        }
    },
    FindPartOnRay = {
        ArgCountRequired = 2,
        Args = {
            "Instance", "Ray", "Instance", "boolean", "boolean"
        }
    },
    Raycast = {
        ArgCountRequired = 3,
        Args = {
            "Instance", "Vector3", "Vector3", "RaycastParams"
        }
    }
}

function CalculateChance(Percentage)
    Percentage = math.floor(Percentage)
    local chance = math.floor(Random.new().NextNumber(Random.new(), 0, 1) * 100) / 100
    return chance <= Percentage / 100
end

--[[file handling]] do 
    if not isfolder(MainFileName) then 
        makefolder(MainFileName);
    end
    
    if not isfolder(string.format("%s/%s", MainFileName, tostring(game.PlaceId))) then 
        makefolder(string.format("%s/%s", MainFileName, tostring(game.PlaceId)))
    end
end

local Files = listfiles(string.format("%s/%s", "UniversalSilentAim", tostring(game.PlaceId)))

-- functions
local function GetFiles()
    local out = {}
    for i = 1, #Files do
        local file = Files[i]
        if file:sub(-4) == '.lua' then
            local pos = file:find('.lua', 1, true)
            local start = pos

            local char = file:sub(pos, pos)
            while char ~= '/' and char ~= '\\' and char ~= '' do
                pos = pos - 1
                char = file:sub(pos, pos)
            end

            if char == '/' or char == '\\' then
                table.insert(out, file:sub(pos + 1, start - 1))
            end
        end
    end
    
    return out
end

local function GetTeamsList()
    local teamsList = {"None"}
    for _, team in pairs(Teams:GetTeams()) do
        table.insert(teamsList, team.Name)
    end
    return teamsList
end

local function UpdateFile(FileName)
    assert(FileName or FileName == "string", "oopsies");
    writefile(string.format("%s/%s/%s.lua", MainFileName, tostring(game.PlaceId), FileName), HttpService:JSONEncode(SilentAimSettings))
end

local function LoadFile(FileName)
    assert(FileName or FileName == "string", "oopsies");
    
    local File = string.format("%s/%s/%s.lua", MainFileName, tostring(game.PlaceId), FileName)
    local ConfigData = HttpService:JSONDecode(readfile(File))
    for Index, Value in next, ConfigData do
        SilentAimSettings[Index] = Value
    end
end

local function getPositionOnScreen(Vector)
    local Vec3, OnScreen = WorldToScreen(Camera, Vector)
    return Vector2.new(Vec3.X, Vec3.Y), OnScreen
end

local function ValidateArguments(Args, RayMethod)
    local Matches = 0
    if #Args < RayMethod.ArgCountRequired then
        return false
    end
    for Pos, Argument in next, Args do
        if typeof(Argument) == RayMethod.Args[Pos] then
            Matches = Matches + 1
        end
    end
    return Matches >= RayMethod.ArgCountRequired
end

local function getDirection(Origin, Position)
    return (Position - Origin).Unit * 1000
end

local function getMousePosition()
    return GetMouseLocation(UserInputService)
end

local function IsPlayerVisible(Player)
    local PlayerCharacter = Player.Character
    local LocalPlayerCharacter = LocalPlayer.Character
    
    if not (PlayerCharacter or LocalPlayerCharacter) then return end 
    
    local PlayerRoot = FindFirstChild(PlayerCharacter, SilentAimSettings.TargetPart) or FindFirstChild(PlayerCharacter, "HumanoidRootPart")
    
    if not PlayerRoot then return end 
    
    local CastPoints, IgnoreList = {PlayerRoot.Position, LocalPlayerCharacter, PlayerCharacter}, {LocalPlayerCharacter, PlayerCharacter}
    local ObscuringObjects = #GetPartsObscuringTarget(Camera, CastPoints, IgnoreList)
    
    return ((ObscuringObjects == 0 and true) or (ObscuringObjects > 0 and false))
end

local function getClosestPlayer()
    if not SilentAimSettings.TargetPart then return end
    
    -- If target is locked, return locked target
    if SilentAimSettings.TargetLocked and SilentAimSettings.LockedTarget then
        local LockedPlayer = SilentAimSettings.LockedTarget
        
        -- Check if player is still in game
        if not LockedPlayer.Parent then
            -- Player left the server, unlock
            SilentAimSettings.TargetLocked = false
            SilentAimSettings.LockedTarget = nil
        else
            local Character = LockedPlayer.Character
            
            if Character then
                local HumanoidRootPart = FindFirstChild(Character, "HumanoidRootPart")
                local Humanoid = FindFirstChild(Character, "Humanoid")
                
                if HumanoidRootPart and Humanoid and Humanoid.Health > 0 then
                    local TargetPart = ((SilentAimSettings.TargetPart == "Random" and Character[ValidTargetParts[math.random(1, #ValidTargetParts)]]) or Character[SilentAimSettings.TargetPart])
                    return TargetPart, LockedPlayer
                else
                    -- Locked target is dead or invalid, unlock
                    SilentAimSettings.TargetLocked = false
                    SilentAimSettings.LockedTarget = nil
                end
            else
                -- Locked target no longer has character, unlock
                SilentAimSettings.TargetLocked = false
                SilentAimSettings.LockedTarget = nil
            end
        end
    end
    
    -- Normal targeting logic
    local Closest
    local ClosestPlayer
    local DistanceToMouse
    
    for _, Player in next, GetPlayers(Players) do
        if Player == LocalPlayer then continue end
        
        -- Team Check
        if SilentAimSettings.TeamCheck and Player.Team == LocalPlayer.Team then continue end
        
        -- Team Aim Target Check
        if SilentAimSettings.TeamAimTarget ~= "None" then
            if not Player.Team or Player.Team.Name ~= SilentAimSettings.TeamAimTarget then
                continue
            end
        end

        local Character = Player.Character
        if not Character then continue end
        
        if SilentAimSettings.VisibleCheck and not IsPlayerVisible(Player) then continue end

        local HumanoidRootPart = FindFirstChild(Character, "HumanoidRootPart")
        local Humanoid = FindFirstChild(Character, "Humanoid")
        if not HumanoidRootPart or not Humanoid or Humanoid and Humanoid.Health <= 0 then continue end

        local ScreenPosition, OnScreen = getPositionOnScreen(HumanoidRootPart.Position)
        if not OnScreen then continue end

        local Distance = (getMousePosition() - ScreenPosition).Magnitude
        
        -- Apply max distance filter
        if Distance > SilentAimSettings.MaxDistance then continue end
        
        -- Apply target priority logic
        if SilentAimSettings.TargetPriority == "Closest" then
            if Distance <= (DistanceToMouse or SilentAimSettings.FOVRadius or 2000) then
                Closest = ((SilentAimSettings.TargetPart == "Random" and Character[ValidTargetParts[math.random(1, #ValidTargetParts)]]) or Character[SilentAimSettings.TargetPart])
                ClosestPlayer = Player
                DistanceToMouse = Distance
            end
        elseif SilentAimSettings.TargetPriority == "Farthest" then
            if Distance <= SilentAimSettings.FOVRadius and Distance >= (DistanceToMouse or 0) then
                Closest = ((SilentAimSettings.TargetPart == "Random" and Character[ValidTargetParts[math.random(1, #ValidTargetParts)]]) or Character[SilentAimSettings.TargetPart])
                ClosestPlayer = Player
                DistanceToMouse = Distance
            end
        end
    end
    return Closest, ClosestPlayer
end

--[[
    ═══════════════════════════════════════════════════════════
                    MOBILE-OPTIMIZED GUI (COMPACT)
    ═══════════════════════════════════════════════════════════
]]

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SilentAimMobileGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
pcall(function() protectgui(ScreenGui) end)
ScreenGui.Parent = game:GetService("CoreGui")

-- Main Frame (More Compact for Mobile)
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 280, 0, 400)
MainFrame.Position = UDim2.new(0.5, -140, 0.5, -200)
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 25)
MainFrame.BorderSizePixel = 0
MainFrame.Active = true
MainFrame.Draggable = true
MainFrame.Visible = false
MainFrame.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 8)
MainCorner.Parent = MainFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 35)
TitleBar.BackgroundColor3 = Color3.fromRGB(54, 57, 241)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

local TitleCorner = Instance.new("UICorner")
TitleCorner.CornerRadius = UDim.new(0, 8)
TitleCorner.Parent = TitleBar

local TitleFix = Instance.new("Frame")
TitleFix.Size = UDim2.new(1, 0, 0, 8)
TitleFix.Position = UDim2.new(0, 0, 1, -8)
TitleFix.BackgroundColor3 = Color3.fromRGB(54, 57, 241)
TitleFix.BorderSizePixel = 0
TitleFix.Parent = TitleBar

local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(1, -70, 1, 0)
TitleLabel.Position = UDim2.new(0, 8, 0, 0)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "Silent Aim"
TitleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
TitleLabel.TextSize = 14
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = TitleBar

local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -33, 0, 2.5)
CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
CloseButton.Text = "X"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.TextSize = 14
CloseButton.Font = Enum.Font.GothamBold
CloseButton.Parent = TitleBar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 5)
CloseCorner.Parent = CloseButton

CloseButton.MouseButton1Click:Connect(function()
    MainFrame.Visible = false
end)

-- Content ScrollingFrame
local ContentFrame = Instance.new("ScrollingFrame")
ContentFrame.Name = "ContentFrame"
ContentFrame.Size = UDim2.new(1, -12, 1, -43)
ContentFrame.Position = UDim2.new(0, 6, 0, 39)
ContentFrame.BackgroundTransparency = 1
ContentFrame.ScrollBarThickness = 3
ContentFrame.BorderSizePixel = 0
ContentFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
ContentFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
ContentFrame.Parent = MainFrame

local ContentLayout = Instance.new("UIListLayout")
ContentLayout.SortOrder = Enum.SortOrder.LayoutOrder
ContentLayout.Padding = UDim.new(0, 6)
ContentLayout.Parent = ContentFrame

-- Helper: Create Section Header
local function CreateSection(title)
    local Section = Instance.new("Frame")
    Section.Size = UDim2.new(1, 0, 0, 25)
    Section.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
    Section.BorderSizePixel = 0
    Section.Parent = ContentFrame
    
    local SectionCorner = Instance.new("UICorner")
    SectionCorner.CornerRadius = UDim.new(0, 5)
    SectionCorner.Parent = Section
    
    local SectionTitle = Instance.new("TextLabel")
    SectionTitle.Size = UDim2.new(1, -8, 1, 0)
    SectionTitle.Position = UDim2.new(0, 8, 0, 0)
    SectionTitle.BackgroundTransparency = 1
    SectionTitle.Text = title
    SectionTitle.TextColor3 = Color3.fromRGB(200, 200, 255)
    SectionTitle.TextSize = 12
    SectionTitle.Font = Enum.Font.GothamBold
    SectionTitle.TextXAlignment = Enum.TextXAlignment.Left
    SectionTitle.Parent = Section
    
    return Section
end

-- Helper: Create Toggle
local function CreateToggle(text, defaultValue, callback)
    local Toggle = Instance.new("Frame")
    Toggle.Size = UDim2.new(1, 0, 0, 38)
    Toggle.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    Toggle.BorderSizePixel = 0
    Toggle.Parent = ContentFrame
    
    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 5)
    ToggleCorner.Parent = Toggle
    
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(1, -55, 1, 0)
    Label.Position = UDim2.new(0, 8, 0, 0)
    Label.BackgroundTransparency = 1
    Label.Text = text
    Label.TextColor3 = Color3.fromRGB(255, 255, 255)
    Label.TextSize = 11
    Label.Font = Enum.Font.Gotham
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Parent = Toggle
    
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(0, 45, 0, 24)
    Button.Position = UDim2.new(1, -48, 0.5, -12)
    Button.BackgroundColor3 = defaultValue and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
    Button.Text = defaultValue and "ON" or "OFF"
    Button.TextColor3 = Color3.fromRGB(255, 255, 255)
    Button.TextSize = 10
    Button.Font = Enum.Font.GothamBold
    Button.Parent = Toggle
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 4)
    ButtonCorner.Parent = Button
    
    local value = defaultValue
    Button.MouseButton1Click:Connect(function()
        value = not value
        Button.BackgroundColor3 = value and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
        Button.Text = value and "ON" or "OFF"
        if callback then callback(value) end
    end)
    
    return Toggle, function() return value end, function(newValue)
        value = newValue
        Button.BackgroundColor3 = value and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
        Button.Text = value and "ON" or "OFF"
    end
end

-- Helper: Create Slider
local function CreateSlider(text, min, max, default, callback)
    local Slider = Instance.new("Frame")
    Slider.Size = UDim2.new(1, 0, 0, 52)
    Slider.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    Slider.BorderSizePixel = 0
    Slider.Parent = ContentFrame
    
    local SliderCorner = Instance.new("UICorner")
    SliderCorner.CornerRadius = UDim.new(0, 5)
    SliderCorner.Parent = Slider
    
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(1, -16, 0, 18)
    Label.Position = UDim2.new(0, 8, 0, 4)
    Label.BackgroundTransparency = 1
    Label.Text = text .. ": " .. tostring(default)
    Label.TextColor3 = Color3.fromRGB(255, 255, 255)
    Label.TextSize = 11
    Label.Font = Enum.Font.Gotham
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Parent = Slider
    
    local SliderBar = Instance.new("Frame")
    SliderBar.Size = UDim2.new(1, -16, 0, 4)
    SliderBar.Position = UDim2.new(0, 8, 0, 30)
    SliderBar.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
    SliderBar.BorderSizePixel = 0
    SliderBar.Parent = Slider
    
    local SliderBarCorner = Instance.new("UICorner")
    SliderBarCorner.CornerRadius = UDim.new(1, 0)
    SliderBarCorner.Parent = SliderBar
    
    local SliderFill = Instance.new("Frame")
    SliderFill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
    SliderFill.BackgroundColor3 = Color3.fromRGB(54, 57, 241)
    SliderFill.BorderSizePixel = 0
    SliderFill.Parent = SliderBar
    
    local SliderFillCorner = Instance.new("UICorner")
    SliderFillCorner.CornerRadius = UDim.new(1, 0)
    SliderFillCorner.Parent = SliderFill
    
    local SliderButton = Instance.new("TextButton")
    SliderButton.Size = UDim2.new(0, 16, 0, 16)
    SliderButton.Position = UDim2.new((default - min) / (max - min), -8, 0.5, -8)
    SliderButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    SliderButton.Text = ""
    SliderButton.Parent = SliderBar
    
    local SliderButtonCorner = Instance.new("UICorner")
    SliderButtonCorner.CornerRadius = UDim.new(1, 0)
    SliderButtonCorner.Parent = SliderButton
    
    local value = default
    local dragging = false
    
    SliderButton.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
        end
    end)
    
    UserInputService.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local mousePos = UserInputService:GetMouseLocation().X
            local barPos = SliderBar.AbsolutePosition.X
            local barSize = SliderBar.AbsoluteSize.X
            local relativePos = math.clamp((mousePos - barPos) / barSize, 0, 1)
            
            value = math.floor(min + (max - min) * relativePos)
            SliderFill.Size = UDim2.new(relativePos, 0, 1, 0)
            SliderButton.Position = UDim2.new(relativePos, -8, 0.5, -8)
            Label.Text = text .. ": " .. tostring(value)
            
            if callback then callback(value) end
        end
    end)
    
    return Slider, function() return value end, function(newValue)
        value = math.clamp(newValue, min, max)
        local relativePos = (value - min) / (max - min)
        SliderFill.Size = UDim2.new(relativePos, 0, 1, 0)
        SliderButton.Position = UDim2.new(relativePos, -8, 0.5, -8)
        Label.Text = text .. ": " .. tostring(value)
    end
end

-- Helper: Create Cycle Button (Click to cycle through options)
local function CreateCycleButton(text, options, default, callback)
    local CycleFrame = Instance.new("Frame")
    CycleFrame.Size = UDim2.new(1, 0, 0, 38)
    CycleFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    CycleFrame.BorderSizePixel = 0
    CycleFrame.Parent = ContentFrame
    
    local CycleCorner = Instance.new("UICorner")
    CycleCorner.CornerRadius = UDim.new(0, 5)
    CycleCorner.Parent = CycleFrame
    
    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(0.38, 0, 1, 0)
    Label.Position = UDim2.new(0, 8, 0, 0)
    Label.BackgroundTransparency = 1
    Label.Text = text
    Label.TextColor3 = Color3.fromRGB(255, 255, 255)
    Label.TextSize = 10
    Label.Font = Enum.Font.Gotham
    Label.TextXAlignment = Enum.TextXAlignment.Left
    Label.Parent = CycleFrame
    
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(0.58, 0, 0, 28)
    Button.Position = UDim2.new(0.4, 0, 0.5, -14)
    Button.BackgroundColor3 = Color3.fromRGB(54, 57, 241)
    Button.Text = default
    Button.TextColor3 = Color3.fromRGB(255, 255, 255)
    Button.TextSize = 9
    Button.Font = Enum.Font.GothamBold
    Button.Parent = CycleFrame
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 4)
    ButtonCorner.Parent = Button
    
    local currentIndex = 1
    for i, option in ipairs(options) do
        if option == default then
            currentIndex = i
            break
        end
    end
    
    local value = default
    
    Button.MouseButton1Click:Connect(function()
        currentIndex = currentIndex + 1
        if currentIndex > #options then
            currentIndex = 1
        end
        value = options[currentIndex]
        Button.Text = value
        if callback then callback(value) end
    end)
    
    return CycleFrame, function() return value end, function(newValue)
        value = newValue
        Button.Text = newValue
        for i, option in ipairs(options) do
            if option == newValue then
                currentIndex = i
                break
            end
        end
    end
end

-- Helper: Create Button
local function CreateButton(text, callback)
    local Button = Instance.new("TextButton")
    Button.Size = UDim2.new(1, 0, 0, 35)
    Button.BackgroundColor3 = Color3.fromRGB(54, 57, 241)
    Button.Text = text
    Button.TextColor3 = Color3.fromRGB(255, 255, 255)
    Button.TextSize = 11
    Button.Font = Enum.Font.GothamBold
    Button.BorderSizePixel = 0
    Button.Parent = ContentFrame
    
    local ButtonCorner = Instance.new("UICorner")
    ButtonCorner.CornerRadius = UDim.new(0, 5)
    ButtonCorner.Parent = Button
    
    Button.MouseButton1Click:Connect(function()
        if callback then callback() end
    end)
    
    return Button
end

-- Helper: Create TextInput
local function CreateTextInput(placeholderText, callback)
    local InputFrame = Instance.new("Frame")
    InputFrame.Size = UDim2.new(1, 0, 0, 38)
    InputFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
    InputFrame.BorderSizePixel = 0
    InputFrame.Parent = ContentFrame
    
    local InputCorner = Instance.new("UICorner")
    InputCorner.CornerRadius = UDim.new(0, 5)
    InputCorner.Parent = InputFrame
    
    local TextBox = Instance.new("TextBox")
    TextBox.Size = UDim2.new(1, -12, 1, -6)
    TextBox.Position = UDim2.new(0, 6, 0, 3)
    TextBox.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
    TextBox.PlaceholderText = placeholderText
    TextBox.Text = ""
    TextBox.TextColor3 = Color3.fromRGB(255, 255, 255)
    TextBox.PlaceholderColor3 = Color3.fromRGB(140, 140, 140)
    TextBox.TextSize = 10
    TextBox.Font = Enum.Font.Gotham
    TextBox.ClearTextOnFocus = false
    TextBox.Parent = InputFrame
    
    local TextBoxCorner = Instance.new("UICorner")
    TextBoxCorner.CornerRadius = UDim.new(0, 4)
    TextBoxCorner.Parent = TextBox
    
    if callback then
        TextBox.FocusLost:Connect(function()
            callback(TextBox.Text)
        end)
    end
    
    return InputFrame, TextBox
end

--[[
    ═══════════════════════════════════════════════════════════
                        BUILD GUI SECTIONS
    ═══════════════════════════════════════════════════════════
]]

-- Main Settings
CreateSection("Main Settings")

local _, getEnabled, setEnabled = CreateToggle("Silent Aim Enabled", SilentAimSettings.Enabled, function(value)
    SilentAimSettings.Enabled = value
    mouse_box.Visible = value and SilentAimSettings.ShowSilentAimTarget
end)

local _, getTeamCheck, setTeamCheck = CreateToggle("Team Check", SilentAimSettings.TeamCheck, function(value)
    SilentAimSettings.TeamCheck = value
end)

local _, getVisibleCheck, setVisibleCheck = CreateToggle("Visible Check", SilentAimSettings.VisibleCheck, function(value)
    SilentAimSettings.VisibleCheck = value
end)

local _, getMethod, setMethod = CreateCycleButton("Aim Method", {
    "Raycast",
    "FindPartOnRay",
    "FindPartOnRayWithWhitelist",
    "FindPartOnRayWithIgnoreList",
    "Mouse.Hit/Target"
}, SilentAimSettings.SilentAimMethod, function(value)
    SilentAimSettings.SilentAimMethod = value
end)

local _, getTargetPart, setTargetPart = CreateCycleButton("Target Part", {"Head", "HumanoidRootPart", "Random"}, SilentAimSettings.TargetPart, function(value)
    SilentAimSettings.TargetPart = value
end)

local _, getTargetPriority, setTargetPriority = CreateCycleButton("Target Priority", {"Closest", "Farthest"}, SilentAimSettings.TargetPriority, function(value)
    SilentAimSettings.TargetPriority = value
end)

local teamsList = GetTeamsList()
local _, getTeamAim, setTeamAim = CreateCycleButton("Team Aim Target", teamsList, SilentAimSettings.TeamAimTarget, function(value)
    SilentAimSettings.TeamAimTarget = value
end)

local _, getHitChance, setHitChance = CreateSlider("Hit Chance", 0, 100, SilentAimSettings.HitChance, function(value)
    SilentAimSettings.HitChance = value
end)

local _, getMaxDistance, setMaxDistance = CreateSlider("Max Distance", 100, 5000, SilentAimSettings.MaxDistance, function(value)
    SilentAimSettings.MaxDistance = value
end)

-- FOV Settings
CreateSection("FOV Settings")

local _, getFOVVisible, setFOVVisible = CreateToggle("Show FOV Circle", SilentAimSettings.FOVVisible, function(value)
    SilentAimSettings.FOVVisible = value
    fov_circle.Visible = value
end)

local _, getFOVRadius, setFOVRadius = CreateSlider("FOV Radius", 0, 360, SilentAimSettings.FOVRadius, function(value)
    SilentAimSettings.FOVRadius = value
    fov_circle.Radius = value
end)

local _, getShowTarget, setShowTarget = CreateToggle("Show Target Box", SilentAimSettings.ShowSilentAimTarget, function(value)
    SilentAimSettings.ShowSilentAimTarget = value
    mouse_box.Visible = value and SilentAimSettings.Enabled
end)

-- Prediction Settings
CreateSection("Prediction (Mouse.Hit/Target)")

local _, getPrediction, setPrediction = CreateToggle("Enable Prediction", SilentAimSettings.MouseHitPrediction, function(value)
    SilentAimSettings.MouseHitPrediction = value
end)

local _, getPredAmount, setPredAmount = CreateSlider("Prediction Amount", 0, 1000, math.floor(SilentAimSettings.MouseHitPredictionAmount * 1000), function(value)
    SilentAimSettings.MouseHitPredictionAmount = value / 1000
    PredictionAmount = value / 1000
end)

-- Configuration
CreateSection("Configuration")

local configNameInput, configTextBox = CreateTextInput("Enter config name...")

CreateButton("Save Configuration", function()
    local configName = configTextBox.Text
    if configName and configName ~= "" then
        UpdateFile(configName)
        configTextBox.Text = ""
    end
end)

local savedConfigs = GetFiles()
local _, getLoadConfig, setLoadConfig = CreateCycleButton("Load Config", #savedConfigs > 0 and savedConfigs or {"No configs"}, #savedConfigs > 0 and savedConfigs[1] or "No configs", function(value)
    if value ~= "No configs" then
        LoadFile(value)
        
        -- Update GUI after loading
        setEnabled(SilentAimSettings.Enabled)
        setTeamCheck(SilentAimSettings.TeamCheck)
        setVisibleCheck(SilentAimSettings.VisibleCheck)
        setTargetPart(SilentAimSettings.TargetPart)
        setMethod(SilentAimSettings.SilentAimMethod)
        setTargetPriority(SilentAimSettings.TargetPriority)
        setTeamAim(SilentAimSettings.TeamAimTarget or "None")
        setFOVVisible(SilentAimSettings.FOVVisible)
        setFOVRadius(SilentAimSettings.FOVRadius)
        setShowTarget(SilentAimSettings.ShowSilentAimTarget)
        setPrediction(SilentAimSettings.MouseHitPrediction)
        setPredAmount(math.floor(SilentAimSettings.MouseHitPredictionAmount * 1000))
        setHitChance(SilentAimSettings.HitChance)
        setMaxDistance(SilentAimSettings.MaxDistance)
        
        -- Update visual elements
        fov_circle.Visible = SilentAimSettings.FOVVisible
        fov_circle.Radius = SilentAimSettings.FOVRadius
        mouse_box.Visible = SilentAimSettings.ShowSilentAimTarget and SilentAimSettings.Enabled
    end
end)

--[[
    ═══════════════════════════════════════════════════════════
                    FLOATING TOGGLE BUTTONS
    ═══════════════════════════════════════════════════════════
]]

-- Menu Toggle Button
local MenuToggle = Instance.new("TextButton")
MenuToggle.Name = "MenuToggle"
MenuToggle.Size = UDim2.new(0, 50, 0, 50)
MenuToggle.Position = UDim2.new(1, -60, 0.5, -115)
MenuToggle.BackgroundColor3 = Color3.fromRGB(54, 57, 241)
MenuToggle.Text = "GUI"
MenuToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
MenuToggle.TextSize = 13
MenuToggle.Font = Enum.Font.GothamBold
MenuToggle.Active = true
MenuToggle.Draggable = true
MenuToggle.Parent = ScreenGui

local MenuToggleCorner = Instance.new("UICorner")
MenuToggleCorner.CornerRadius = UDim.new(1, 0)
MenuToggleCorner.Parent = MenuToggle

MenuToggle.MouseButton1Click:Connect(function()
    MainFrame.Visible = not MainFrame.Visible
end)

-- Silent Aim Toggle Button
local SAToggle = Instance.new("TextButton")
SAToggle.Name = "SAToggle"
SAToggle.Size = UDim2.new(0, 50, 0, 50)
SAToggle.Position = UDim2.new(1, -60, 0.5, -55)
SAToggle.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
SAToggle.Text = "AIM"
SAToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
SAToggle.TextSize = 12
SAToggle.Font = Enum.Font.GothamBold
SAToggle.Active = true
SAToggle.Draggable = true
SAToggle.Parent = ScreenGui

local SAToggleCorner = Instance.new("UICorner")
SAToggleCorner.CornerRadius = UDim.new(1, 0)
SAToggleCorner.Parent = SAToggle

SAToggle.MouseButton1Click:Connect(function()
    SilentAimSettings.Enabled = not SilentAimSettings.Enabled
    setEnabled(SilentAimSettings.Enabled)
    SAToggle.BackgroundColor3 = SilentAimSettings.Enabled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
    mouse_box.Visible = SilentAimSettings.Enabled and SilentAimSettings.ShowSilentAimTarget
end)

-- Priority Toggle Button (CLS/FAR)
local PriorityToggle = Instance.new("TextButton")
PriorityToggle.Name = "PriorityToggle"
PriorityToggle.Size = UDim2.new(0, 50, 0, 50)
PriorityToggle.Position = UDim2.new(1, -60, 0.5, 5)
PriorityToggle.BackgroundColor3 = Color3.fromRGB(241, 196, 15)
PriorityToggle.Text = "CLS"
PriorityToggle.TextColor3 = Color3.fromRGB(255, 255, 255)
PriorityToggle.TextSize = 12
PriorityToggle.Font = Enum.Font.GothamBold
PriorityToggle.Active = true
PriorityToggle.Draggable = true
PriorityToggle.Parent = ScreenGui

local PriorityToggleCorner = Instance.new("UICorner")
PriorityToggleCorner.CornerRadius = UDim.new(1, 0)
PriorityToggleCorner.Parent = PriorityToggle

PriorityToggle.MouseButton1Click:Connect(function()
    if SilentAimSettings.TargetPriority == "Closest" then
        SilentAimSettings.TargetPriority = "Farthest"
        PriorityToggle.Text = "FAR"
        PriorityToggle.BackgroundColor3 = Color3.fromRGB(155, 89, 182)
    else
        SilentAimSettings.TargetPriority = "Closest"
        PriorityToggle.Text = "CLS"
        PriorityToggle.BackgroundColor3 = Color3.fromRGB(241, 196, 15)
    end
    setTargetPriority(SilentAimSettings.TargetPriority)
end)

-- Target Lock Display Button
local TargetLockButton = Instance.new("TextButton")
TargetLockButton.Name = "TargetLockButton"
TargetLockButton.Size = UDim2.new(0, 140, 0, 35)
TargetLockButton.Position = UDim2.new(0.5, -70, 0, 10)
TargetLockButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
TargetLockButton.BackgroundTransparency = 0.7
TargetLockButton.Text = "No Target"
TargetLockButton.TextColor3 = Color3.fromRGB(255, 255, 255)
TargetLockButton.TextSize = 11
TargetLockButton.Font = Enum.Font.GothamBold
TargetLockButton.BorderSizePixel = 1
TargetLockButton.BorderColor3 = Color3.fromRGB(200, 200, 200)
TargetLockButton.Active = true
TargetLockButton.Draggable = true
TargetLockButton.Parent = ScreenGui

local TargetLockCorner = Instance.new("UICorner")
TargetLockCorner.CornerRadius = UDim.new(0, 6)
TargetLockCorner.Parent = TargetLockButton

TargetLockButton.MouseButton1Click:Connect(function()
    if SilentAimSettings.TargetLocked then
        -- Unlock target
        SilentAimSettings.TargetLocked = false
        SilentAimSettings.LockedTarget = nil
        TargetLockButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        TargetLockButton.BackgroundTransparency = 0.7
        TargetLockButton.BorderColor3 = Color3.fromRGB(200, 200, 200)
        TargetLockButton.Text = "No Target"
    else
        -- Lock current target - try multiple times to find a target
        local attempts = 0
        local maxAttempts = 10
        local _, currentTarget = getClosestPlayer()
        
        while not currentTarget and attempts < maxAttempts do
            wait(0.1)
            _, currentTarget = getClosestPlayer()
            attempts = attempts + 1
        end
        
        if currentTarget then
            SilentAimSettings.TargetLocked = true
            SilentAimSettings.LockedTarget = currentTarget
            TargetLockButton.BackgroundColor3 = Color3.fromRGB(50, 200, 50)
            TargetLockButton.BackgroundTransparency = 0.3
            TargetLockButton.BorderColor3 = Color3.fromRGB(50, 200, 50)
            TargetLockButton.Text = "LOCKED: " .. currentTarget.Name
        else
            -- No target found after attempts
            TargetLockButton.Text = "No Target Found"
            wait(1)
            TargetLockButton.Text = "No Target"
        end
    end
end)

--[[
    ═══════════════════════════════════════════════════════════
                        RENDER LOOP
    ═══════════════════════════════════════════════════════════
]]

resume(create(function()
    RenderStepped:Connect(function()
        -- Update AIM button color
        SAToggle.BackgroundColor3 = SilentAimSettings.Enabled and Color3.fromRGB(50, 200, 50) or Color3.fromRGB(200, 50, 50)
        
        -- Update target lock button
        local currentTarget, currentTargetPlayer = getClosestPlayer()
        if currentTargetPlayer then
            if SilentAimSettings.TargetLocked then
                TargetLockButton.Text = "LOCKED: " .. currentTargetPlayer.Name
            else
                TargetLockButton.Text = currentTargetPlayer.Name
            end
        else
            if not SilentAimSettings.TargetLocked then
                TargetLockButton.Text = "No Target"
            end
        end
        
        -- Update target box and ESP
        if SilentAimSettings.ShowSilentAimTarget and SilentAimSettings.Enabled then
            local target, targetPlayer = getClosestPlayer()
            if target and targetPlayer then
                local Character = targetPlayer.Character
                if Character then
                    local Root = target.Parent.PrimaryPart or target
                    local Head = FindFirstChild(Character, "Head")
                    local HumanoidRootPart = FindFirstChild(Character, "HumanoidRootPart")
                    
                    if Root and Head and HumanoidRootPart then
                        local RootToViewportPoint, IsOnScreen = WorldToViewportPoint(Camera, Root.Position)
                        local HeadPos2D, OnScreen1 = WorldToViewportPoint(Camera, Head.Position)
                        local RootPos2D, OnScreen2 = WorldToViewportPoint(Camera, HumanoidRootPart.Position)
                        
                        -- Update mouse box
                        mouse_box.Visible = IsOnScreen
                        mouse_box.Position = Vector2.new(RootToViewportPoint.X, RootToViewportPoint.Y)
                        
                        -- Update ESP
                        if OnScreen1 and OnScreen2 then
                            -- Calculate distance
                            local distance = math.floor((Camera.CFrame.Position - HumanoidRootPart.Position).Magnitude)
                            
                            -- Calculate box size
                            local height = math.abs(HeadPos2D.Y - RootPos2D.Y) * 1.2
                            local width = height / 2
                            
                            -- Update bounding box
                            esp_box.Size = Vector2.new(width, height)
                            esp_box.Position = Vector2.new(RootPos2D.X - width/2, RootPos2D.Y - height/2)
                            esp_box.Visible = true
                            
                            -- Update name tag
                            esp_name.Text = targetPlayer.Name
                            esp_name.Position = Vector2.new(HeadPos2D.X, HeadPos2D.Y - 30)
                            esp_name.Visible = true
                            
                            -- Update distance tag
                            esp_distance.Text = distance .. "m"
                            esp_distance.Position = Vector2.new(RootPos2D.X, RootPos2D.Y + height/2 + 15)
                            esp_distance.Visible = true
                            
                            -- Update tracer from center of screen to player
                            esp_tracer.From = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
                            esp_tracer.To = Vector2.new(RootPos2D.X, RootPos2D.Y)
                            esp_tracer.Visible = true
                        else
                            esp_box.Visible = false
                            esp_name.Visible = false
                            esp_distance.Visible = false
                            esp_tracer.Visible = false
                        end
                    else
                        mouse_box.Visible = false
                        esp_box.Visible = false
                        esp_name.Visible = false
                        esp_distance.Visible = false
                        esp_tracer.Visible = false
                    end
                else
                    mouse_box.Visible = false
                    esp_box.Visible = false
                    esp_name.Visible = false
                    esp_distance.Visible = false
                    esp_tracer.Visible = false
                end
            else
                mouse_box.Visible = false
                esp_box.Visible = false
                esp_name.Visible = false
                esp_distance.Visible = false
                esp_tracer.Visible = false
            end
        else
            mouse_box.Visible = false
            esp_box.Visible = false
            esp_name.Visible = false
            esp_distance.Visible = false
            esp_tracer.Visible = false
        end
        
        -- Update FOV circle
        if SilentAimSettings.FOVVisible then
            fov_circle.Visible = true
            fov_circle.Radius = SilentAimSettings.FOVRadius
            fov_circle.Position = getMousePosition()
        else
            fov_circle.Visible = false
        end
    end)
end))

--[[
    ═══════════════════════════════════════════════════════════
                            HOOKS
    ═══════════════════════════════════════════════════════════
]]

-- hooks
local oldNamecall
oldNamecall = hookmetamethod(game, "__namecall", newcclosure(function(...)
    local Method = getnamecallmethod()
    local Arguments = {...}
    local self = Arguments[1]
    local chance = CalculateChance(SilentAimSettings.HitChance)
    if SilentAimSettings.Enabled and self == workspace and not checkcaller() and chance == true then
        if Method == "FindPartOnRayWithIgnoreList" and SilentAimSettings.SilentAimMethod == Method then
            if ValidateArguments(Arguments, ExpectedArguments.FindPartOnRayWithIgnoreList) then
                local A_Ray = Arguments[2]

                local HitPart = getClosestPlayer()
                if HitPart then
                    local Origin = A_Ray.Origin
                    local Direction = getDirection(Origin, HitPart.Position)
                    Arguments[2] = Ray.new(Origin, Direction)

                    return oldNamecall(unpack(Arguments))
                end
            end
        elseif Method == "FindPartOnRayWithWhitelist" and SilentAimSettings.SilentAimMethod == Method then
            if ValidateArguments(Arguments, ExpectedArguments.FindPartOnRayWithWhitelist) then
                local A_Ray = Arguments[2]

                local HitPart = getClosestPlayer()
                if HitPart then
                    local Origin = A_Ray.Origin
                    local Direction = getDirection(Origin, HitPart.Position)
                    Arguments[2] = Ray.new(Origin, Direction)

                    return oldNamecall(unpack(Arguments))
                end
            end
        elseif (Method == "FindPartOnRay" or Method == "findPartOnRay") and SilentAimSettings.SilentAimMethod:lower() == Method:lower() then
            if ValidateArguments(Arguments, ExpectedArguments.FindPartOnRay) then
                local A_Ray = Arguments[2]

                local HitPart = getClosestPlayer()
                if HitPart then
                    local Origin = A_Ray.Origin
                    local Direction = getDirection(Origin, HitPart.Position)
                    Arguments[2] = Ray.new(Origin, Direction)

                    return oldNamecall(unpack(Arguments))
                end
            end
        elseif Method == "Raycast" and SilentAimSettings.SilentAimMethod == Method then
            if ValidateArguments(Arguments, ExpectedArguments.Raycast) then
                local A_Origin = Arguments[2]

                local HitPart = getClosestPlayer()
                if HitPart then
                    Arguments[3] = getDirection(A_Origin, HitPart.Position)

                    return oldNamecall(unpack(Arguments))
                end
            end
        end
    end
    return oldNamecall(...)
end))

local oldIndex = nil 
oldIndex = hookmetamethod(game, "__index", newcclosure(function(self, Index)
    if self == Mouse and not checkcaller() and SilentAimSettings.Enabled and SilentAimSettings.SilentAimMethod == "Mouse.Hit/Target" and getClosestPlayer() then
        local HitPart = getClosestPlayer()
         
        if Index == "Target" or Index == "target" then 
            return HitPart
        elseif Index == "Hit" or Index == "hit" then 
            return ((SilentAimSettings.MouseHitPrediction and (HitPart.CFrame + (HitPart.Velocity * PredictionAmount))) or (not SilentAimSettings.MouseHitPrediction and HitPart.CFrame))
        elseif Index == "X" or Index == "x" then 
            return self.X 
        elseif Index == "Y" or Index == "y" then 
            return self.Y 
        elseif Index == "UnitRay" then 
            return Ray.new(self.Origin, (self.Hit - self.Origin).Unit)
        end
    end

    return oldIndex(self, Index)
end))

print("[Silent Aim] Mobile-optimized GUI loaded!")
print("[Silent Aim] Tap 'GUI' button to open menu")
print("[Silent Aim] Tap 'AIM' button to toggle Silent Aim")
print("[Silent Aim] Tap 'CLS/FAR' button to toggle target priority")
